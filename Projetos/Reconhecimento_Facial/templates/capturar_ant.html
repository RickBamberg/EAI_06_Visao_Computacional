<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <title>Capturar Fotos - Sistema de Reconhecimento Facial</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/capturar.css') }}">
</head>

<body>
    <header>
        <div class="header-title">
             <p>Sistema de Reconhecimento Facial</p>
        </div>
    </header>

    <nav>
        <div class="nav-container">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="{{ url_for('index') }}" class="nav-btn">In√≠cio</a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('capturar') }}" class="nav-btn active">Capturar</a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('tratar') }}" class="nav-btn">Tratar</a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('reconhecer') }}" class="nav-btn">Reconhecer</a>
                </li>
            </ul>
        </div>
    </nav>

    <main>
        <div class="capture-container">
            <!-- Painel de Configura√ß√£o (Esquerda) -->
            <div class="config-panel">
            <!--    <h3>Configura√ß√µes de Captura</h3> -->
                
                <div class="card" style="background-color: #2c3e50; border: 1px solid #4a6491; margin-bottom: 20px;">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="nomePessoa" class="form-label">Nome da Pessoa:</label>
                            <input type="text" class="form-control" id="nomePessoa" value=" " placeholder="Digite o nome">
                        </div>
                        <div class="mb-3">
                            <label for="numFotos" class="form-label">N√∫mero de Fotos:</label>
                            <input type="number" class="form-control" id="numFotos" value="5" min="1" max="20">
                        </div>
                        <div class="controls">
                            <button id="btnIniciar" class="btn btn-capture w-100 mb-2">Iniciar Captura</button>
                            <button id="btnParar" class="btn btn-stop w-100" style="display: none;">Parar Captura</button>
                        </div>
                    </div>
                </div>

                <!-- Status -->
                <!--<div id="status" class="status" style="display: none;"></div> -->

                <!-- Instru√ß√µes -->
                <!--<div class="alert alert-info" style="background-color: rgba(52, 152, 219, 0.2); border-color: #3498db;">
                    <h6>Instru√ß√µes:</h6>
                    <ol style="font-size: 0.9em; margin: 10px 0;">
                        <li>Digite o nome da pessoa</li>
                        <li>Defina quantas fotos capturar</li>
                        <li>Clique em "Iniciar Captura"</li>
                        <li>Posicione-se na c√¢mera</li>
                        <li>Use o bot√£o ou tecla 's' para cada foto</li>
                    </ol>
                </div>  -->
            </div>

            <!-- Painel do V√≠deo (Direita) -->
            <div class="video-panel">
            <!--    <h3>Preview da C√¢mera</h3> -->
                
                <!-- Container do v√≠deo -->
                <div class="video-container" id="videoContainer" style="display: none;">
                    <img id="videoFeed" src="" alt="Feed da c√¢mera">
                </div>

                <!-- Bot√£o de captura -->
                <div class="controls">
                    <button id="btnCapturarFoto" class="btn btn-capture" style="display: none;" disabled>
                        üì∏ Capturar Foto (ou pressione 's')
                    </button>
                </div>

                <!-- Mensagem quando c√¢mera n√£o est√° ativa -->
                <div id="cameraPlaceholder" class="text-center" style="padding: 100px 20px; background-color: #2c3e50; border: 2px dashed #4a6491; border-radius: 10px;">
                    <h4>üìπ C√¢mera Inativa</h4>
                    <p>Clique em "Iniciar Captura" para ativar a c√¢mera</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-lbl">
            <p>Mensagem: <span id="footerMessage">Sistema pronto para captura</span></p>
        </div>
    </footer>

    <script>
        let capturaAtiva = false;
        let statusInterval;

        function atualizarStatus(message, tipo = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.className = `status alert-${tipo}`;
            statusDiv.textContent = message;
            
            document.getElementById('footerMessage').textContent = message;
        }

        function atualizarStatusCaptura() {
            if (!capturaAtiva) return;
            
            fetch('/status_captura')
                .then(response => response.json())
                .then(data => {
                    if (data.capturando) {
                        atualizarStatus(`Capturando para ${data.nome_pessoa} - ${data.fotos_capturadas}/${data.num_fotos} fotos`, 'info');
                        document.getElementById('btnCapturarFoto').disabled = false;
                    } else {
                        // Captura finalizada
                        if (data.fotos_capturadas > 0) {
                            atualizarStatus(`Captura finalizada! ${data.fotos_capturadas} fotos salvas para ${data.nome_pessoa}`, 'success');
                        }
                        pararCaptura();
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar status:', error);
                });
        }

        function iniciarCaptura() {
            const nomePessoa = document.getElementById('nomePessoa').value.trim();
            const numFotos = document.getElementById('numFotos').value;

            if (!nomePessoa) {
                atualizarStatus('Por favor, digite o nome da pessoa', 'error');
                return;
            }

            fetch('/iniciar_captura', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nome_pessoa: nomePessoa,
                    num_fotos: numFotos
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    capturaAtiva = true;
                    document.getElementById('videoContainer').style.display = 'block';
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                    document.getElementById('videoFeed').src = '/video_feed';
                    document.getElementById('btnCapturarFoto').style.display = 'inline-block';
                    document.getElementById('btnIniciar').style.display = 'none';
                    document.getElementById('btnParar').style.display = 'inline-block';
                    
                    atualizarStatus('C√¢mera ativada! Posicione-se e clique em "Capturar Foto"', 'success');
                    
                    // Inicia verifica√ß√£o peri√≥dica do status
                    statusInterval = setInterval(atualizarStatusCaptura, 1000);
                } else {
                    atualizarStatus(data.message, 'error');
                }
            })
            .catch(error => {
                atualizarStatus('Erro ao iniciar captura', 'error');
                console.error('Erro:', error);
            });
        }

        function pararCaptura() {
            if (!capturaAtiva) return;

            fetch('/parar_captura', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                capturaAtiva = false;
                clearInterval(statusInterval);
                
                document.getElementById('videoContainer').style.display = 'none';
                document.getElementById('cameraPlaceholder').style.display = 'block';
                document.getElementById('btnCapturarFoto').style.display = 'none';
                document.getElementById('btnIniciar').style.display = 'inline-block';
                document.getElementById('btnParar').style.display = 'none';
                
                atualizarStatus('Captura parada', 'info');
            })
            .catch(error => {
                console.error('Erro ao parar captura:', error);
            });
        }

        function capturarFoto() {
            if (!capturaAtiva) return;
            
            // Desabilita o bot√£o temporariamente
            const btnCapturar = document.getElementById('btnCapturarFoto');
            btnCapturar.disabled = true;
            btnCapturar.textContent = 'üì∏ Capturando...';

            fetch('/capturar_foto', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    atualizarStatus(data.message, 'success');
                    // Re-habilita o bot√£o ap√≥s um breve delay
                    setTimeout(() => {
                        btnCapturar.disabled = false;
                        btnCapturar.textContent = 'üì∏ Capturar Foto';
                    }, 1000);
                } else if (data.status === 'complete') {
                    atualizarStatus(data.message, 'success');
                    pararCaptura();
                } else {
                    atualizarStatus(data.message, 'error');
                    btnCapturar.disabled = false;
                    btnCapturar.textContent = 'üì∏ Capturar Foto';
                }
            })
            .catch(error => {
                atualizarStatus('Erro ao capturar foto', 'error');
                btnCapturar.disabled = false;
                btnCapturar.textContent = 'üì∏ Capturar Foto';
                console.error('Erro:', error);
            });
        }

        // Event listeners
        document.getElementById('btnIniciar').addEventListener('click', iniciarCaptura);
        document.getElementById('btnParar').addEventListener('click', pararCaptura);
        document.getElementById('btnCapturarFoto').addEventListener('click', capturarFoto);

        // Teclas de atalho
        document.addEventListener('keydown', function(event) {
            if (capturaAtiva) {
                if (event.key === 's' || event.key === 'S') {
                    event.preventDefault();
                    capturarFoto();
                } else if (event.key === 'q' || event.key === 'Q') {
                    event.preventDefault();
                    pararCaptura();
                }
            }
        });

        // Limpa recursos quando a p√°gina √© fechada
        window.addEventListener('beforeunload', function() {
            if (capturaAtiva) {
                fetch('/parar_captura', { method: 'POST' });
            }
        });
    </script>
</body>
</html>