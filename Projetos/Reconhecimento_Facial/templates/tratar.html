<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Tratamento de Imagens - Sistema de Reconhecimento Facial</title>
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #ecf0f1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            margin: 0;
        }

        header {
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            border-bottom: 1px solid #4a6491;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }

        .header-title {
            text-align: center;
        }

        .header-title p {
            font-size: 2.2rem;
            font-weight: 600;
            margin: 0;
            background: linear-gradient(45deg, #3498db, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        nav {
            background: rgba(52, 73, 94, 0.9);
            backdrop-filter: blur(5px);
            padding: 15px 0;
            border-bottom: 1px solid #4a6491;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-menu {
            list-style: none;
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 0;
            padding: 0;
        }

        .nav-btn {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: #ecf0f1;
            padding: 12px 25px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid #4a6491;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #e74c3c;
        }

        main {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .treatment-container {
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid #4a6491;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .treatment-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .treatment-header h2 {
            color: #3498db;
            margin-bottom: 10px;
        }

        .treatment-header p {
            color: #bdc3c7;
            font-size: 1.1rem;
        }

        .process-info {
            background: rgba(52, 73, 94, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #4a6491;
        }

        .process-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(74, 100, 145, 0.3);
            border-radius: 8px;
        }

        .step-number {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .progress-section {
            margin: 25px 0;
        }

        .progress-bar-custom {
            background: rgba(52, 73, 94, 0.8);
            border-radius: 10px;
            height: 25px;
            overflow: hidden;
            border: 1px solid #4a6491;
        }

        .progress-fill {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .status-display {
            background: rgba(52, 73, 94, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #4a6491;
        }

        .btn-treatment {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-treatment:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
            color: white;
        }

        .btn-treatment:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-stop {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-stop:hover {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            color: white;
        }

        .requirements-list {
            background: rgba(74, 100, 145, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .requirements-list h5 {
            color: #f39c12;
            margin-bottom: 15px;
        }

        .requirements-list ul {
            margin: 0;
            padding-left: 20px;
        }

        .requirements-list li {
            margin-bottom: 8px;
            color: #bdc3c7;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .stat-card {
            background: rgba(52, 73, 94, 0.8);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #4a6491;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #bdc3c7;
            font-size: 0.9rem;
        }

        footer {
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #4a6491;
            padding: 15px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        .footer-lbl {
            text-align: center;
        }

        .footer-lbl p {
            margin: 0;
            color: #bdc3c7;
        }

        .alert-custom {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-indicator {
            text-align: center;
            display: none;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-title">
             <p>Sistema de Reconhecimento Facial</p>
        </div>
    </header>

    <nav>
        <div class="nav-container">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="{{ url_for('index') }}" class="nav-btn">Início</a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('capturar') }}" class="nav-btn">Capturar</a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('preview') }}" class="nav-btn">Preview</a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('tratar') }}" class="nav-btn active">Tratar</a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('reconhecer') }}" class="nav-btn">Reconhecer</a>
                </li>
            </ul>
        </div>
    </nav>

    <main>
        <div class="treatment-container">
            <div class="treatment-header">
                <h2>Tratamento de Imagens</h2>
                <p>Detecta faces nas imagens capturadas e gera embeddings para reconhecimento</p>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="opcaoTratamento" class="form-label">Modo de Tratamento:</label>
                    <select class="form-select" id="opcaoTratamento" style="background-color: #34495e; color: #ecf0f1; border-color: #4a6491;">
                        <option value="todas">Processar todas as pessoas</option>
                        <option value="individual">Processar pessoa específica</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="selecionarPessoa" class="form-label">Selecionar Pessoa:</label>
                    <select class="form-select" id="selecionarPessoa" style="background-color: #34495e; color: #ecf0f1; border-color: #4a6491;" disabled>
                        <option value="">Carregando pessoas...</option>
                    </select>
                </div>
            </div>

            <div class="process-info">
                <h4 style="color: #3498db; margin-bottom: 20px;">Processo de Tratamento</h4>
                
                <div class="process-step">
                    <div class="step-number">1</div>
                    <div>
                        <strong>Detecção Facial:</strong> Utiliza rede neural DNN do OpenCV para detectar faces nas imagens
                    </div>
                </div>
                
                <div class="process-step">
                    <div class="step-number">2</div>
                    <div>
                        <strong>Recorte de Faces:</strong> Extrai e salva apenas a região facial de cada imagem
                    </div>
                </div>
                
                <div class="process-step">
                    <div class="step-number">3</div>
                    <div>
                        <strong>Geração de Embeddings:</strong> Cria representações vetoriais usando modelo FaceNet
                    </div>
                </div>
                
                <div class="process-step">
                    <div class="step-number">4</div>
                    <div>
                        <strong>Banco de Dados:</strong> Salva os embeddings em arquivo pickle para reconhecimento
                    </div>
                </div>
            </div>

            <div class="requirements-list">
                <h5>Requisitos do Sistema</h5>
                <ul>
                    <li>Arquivos do detector facial: deploy.prototxt e res10_300x300_ssd_iter_140000.caffemodel</li>
                    <li>Biblioteca DeepFace instalada (pip install deepface)</li>
                    <li>Imagens capturadas na pasta 'data/'</li>
                    <li>Conexão com internet (para download do modelo FaceNet na primeira execução)</li>
                </ul>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPessoas">0</div>
                    <div class="stat-label">Pessoas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalImagens">0</div>
                    <div class="stat-label">Imagens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="facesDetectadas">?</div>
                    <div class="stat-label">Faces Detectadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="embeddingsGerados">?</div>
                    <div class="stat-label">Embeddings</div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-bar-custom">
                    <div class="progress-fill" id="progressFill">
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </div>
            </div>

            <div class="status-display">
                <h5 style="color: #f39c12;">Status do Sistema</h5>
                <p id="statusMessage">Pronto para processar imagens</p>
            </div>

            <div class="processing-indicator" id="processingIndicator">
                <div class="loading-spinner"></div>
                <p>Processando imagens, aguarde...</p>
            </div>

            <div class="text-center">
                <button id="btnIniciarTratamento" class="btn btn-treatment me-3">
                    Iniciar Tratamento
                </button>
                <button id="btnPararTratamento" class="btn btn-stop" style="display: none;">
                    Parar Tratamento
                </button>
            </div>

            <div class="alert-custom" id="alertMessage" style="display: none;">
                <strong>Informação:</strong> <span id="alertText"></span>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-lbl">
            <p>Mensagem: <span id="footerMessage">Sistema pronto para tratamento</span></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let tratamentoAtivo = false;
        let statusInterval;

        function atualizarStatus(message) {
            document.getElementById('footerMessage').textContent = message;
            document.getElementById('statusMessage').textContent = message;
        }

        function atualizarProgresso(progresso) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${progresso}%`;
            progressText.textContent = `${progresso}%`;
        }

        function atualizarEstatisticas() {
            // Buscar estatísticas das pessoas cadastradas
            fetch('/listar_pessoas')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const totalPessoas = data.pessoas.length;
                        const totalImagens = data.pessoas.reduce((sum, pessoa) => sum + pessoa.total_fotos, 0);
                        
                        document.getElementById('totalPessoas').textContent = totalPessoas;
                        document.getElementById('totalImagens').textContent = totalImagens;
                        
                        // Atualizar dropdown de pessoas
                        const selectPessoa = document.getElementById('selecionarPessoa');
                        selectPessoa.innerHTML = '<option value="">Selecione uma pessoa</option>';
                        
                        data.pessoas.forEach(pessoa => {
                            const option = document.createElement('option');
                            option.value = pessoa.nome;
                            option.textContent = `${pessoa.nome} (${pessoa.total_fotos} fotos)`;
                            selectPessoa.appendChild(option);
                        });
                        
                        // Habilitar dropdown se há pessoas
                        if (data.pessoas.length > 0) {
                            selectPessoa.disabled = false;
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar estatísticas:', error);
                    document.getElementById('selecionarPessoa').innerHTML = '<option value="">Erro ao carregar</option>';
                });
        }

        function verificarEmbeddings() {
            // Verificar embeddings diretamente
            fetch('/verificar_embeddings')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('embeddingsGerados').textContent = data.total_embeddings;
                        document.getElementById('facesDetectadas').textContent = data.total_faces || document.getElementById('facesDetectadas').textContent;
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar embeddings:', error);
                });
        }

        function verificarStatusTratamento() {
            if (!tratamentoAtivo) return;
            
            fetch('/status_tratamento')
                .then(response => response.json())
                .then(data => {
                    atualizarStatus(data.status_message);
                    atualizarProgresso(data.progresso);
                    
                    // Atualizar estatísticas se disponíveis
                    if (data.total_salvas !== undefined) {
                        document.getElementById('facesDetectadas').textContent = data.total_salvas;
                    }
                    
                    if (data.total_embeddings !== undefined) {
                        document.getElementById('embeddingsGerados').textContent = data.total_embeddings;
                    }
                    
                    if (!data.processando) {
                        // Tratamento finalizado
                        tratamentoAtivo = false;
                        clearInterval(statusInterval);
                        
                        document.getElementById('btnIniciarTratamento').style.display = 'inline-block';
                        document.getElementById('btnPararTratamento').style.display = 'none';
                        document.getElementById('processingIndicator').style.display = 'none';
                        
                        // Atualizar estatísticas finais
                        atualizarEstatisticas();
                        verificarEmbeddings();
                        
                        if (data.message && data.message.includes('concluído')) {
                            mostrarAlerta(data.message, 'success');
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar status:', error);
                });
        }

        function iniciarTratamento() {
            if (tratamentoAtivo) return;
            
            // Obter modo de tratamento selecionado
            const opcaoTratamento = document.getElementById('opcaoTratamento').value;
            const selecionarPessoa = document.getElementById('selecionarPessoa');
            
            let dadosRequisicao = {};
            
            if (opcaoTratamento === 'individual') {
                const pessoaSelecionada = selecionarPessoa.value;
                if (!pessoaSelecionada) {
                    mostrarAlerta('Selecione uma pessoa para processar', 'error');
                    return;
                }
                dadosRequisicao = { pessoa_especifica: pessoaSelecionada };
            }
            
            // Debug: verificar dados enviados
            console.log('Enviando dados:', dadosRequisicao);
            
            // Mostrar indicador de processamento
            document.getElementById('processingIndicator').style.display = 'block';
            document.getElementById('btnIniciarTratamento').style.display = 'none';
            document.getElementById('btnPararTratamento').style.display = 'inline-block';
            
            // Resetar estatísticas
            document.getElementById('facesDetectadas').textContent = '0';
            document.getElementById('embeddingsGerados').textContent = '0';
            
            atualizarStatus('Iniciando tratamento...');
            
            fetch('/iniciar_tratamento', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dadosRequisicao)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    tratamentoAtivo = true;
                    atualizarStatus('Tratamento iniciado com sucesso');
                    
                    // Iniciar verificação periódica do status
                    statusInterval = setInterval(verificarStatusTratamento, 1000);
                } else {
                    // Erro ao iniciar
                    atualizarStatus(data.message);
                    document.getElementById('processingIndicator').style.display = 'none';
                    document.getElementById('btnIniciarTratamento').style.display = 'inline-block';
                    document.getElementById('btnPararTratamento').style.display = 'none';
                    
                    mostrarAlerta(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao iniciar tratamento:', error);
                atualizarStatus('Erro ao iniciar tratamento');
                document.getElementById('processingIndicator').style.display = 'none';
                document.getElementById('btnIniciarTratamento').style.display = 'inline-block';
                document.getElementById('btnPararTratamento').style.display = 'none';
                
                mostrarAlerta('Erro de conexão. Verifique o console.', 'error');
            });
        }

        function pararTratamento() {
            if (!tratamentoAtivo) return;
            
            fetch('/parar_tratamento', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                tratamentoAtivo = false;
                clearInterval(statusInterval);
                
                document.getElementById('btnIniciarTratamento').style.display = 'inline-block';
                document.getElementById('btnPararTratamento').style.display = 'none';
                document.getElementById('processingIndicator').style.display = 'none';
                
                atualizarStatus('Tratamento interrompido');
                mostrarAlerta('Tratamento foi interrompido pelo usuário', 'warning');
            })
            .catch(error => {
                console.error('Erro ao parar tratamento:', error);
            });
        }

        function mostrarAlerta(mensagem, tipo = 'info') {
            const alertMessage = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');
            
            alertText.textContent = mensagem;
            alertMessage.style.display = 'block';
            
            // Ocultar após 5 segundos
            setTimeout(() => {
                alertMessage.style.display = 'none';
            }, 5000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar estatísticas iniciais
            atualizarEstatisticas();
            verificarEmbeddings();
            
            // Configurar evento para o dropdown de opções
            document.getElementById('opcaoTratamento').addEventListener('change', function() {
                const selecionarPessoa = document.getElementById('selecionarPessoa');
                selecionarPessoa.disabled = this.value !== 'individual';
            });
            
            // Configurar botões
            document.getElementById('btnIniciarTratamento').addEventListener('click', iniciarTratamento);
            document.getElementById('btnPararTratamento').addEventListener('click', pararTratamento);
        });

        // Limpar recursos ao sair da página
        window.addEventListener('beforeunload', function() {
            if (tratamentoAtivo) {
                fetch('/parar_tratamento', {
                    method: 'POST',
                    keepalive: true
                });
            }
        });
    </script>
</body>
</html>
